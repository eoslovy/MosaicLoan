####
#test_template_trigger:
#tags:
# - $GITLAB_USER_EMAIL
#script:
# - echo "CI ì •ìƒ ì‘ë™ ì—¬ë¶€ í™•ì¸"
# - echo "ğŸ” ë³€ê²½ëœ íŒŒì¼ ëª©ë¡:"
# - git diff --name-only $CI_COMMIT_BEFORE_SHA $CI_COMMIT_SHA

.backend-default-build:
  stage: build
  tags:
    - $GITLAB_USER_EMAIL
  script:
    - echo "ğŸ”¨ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ ì¤‘..."
    - docker build -t ${DOCKERHUB_USERNAME:-default}/$REGISTRY_PATH-${SERVICE_NAME}:$IMAGE_TAG ${BUILD_CONTEXT}
    #- echo "âœ… ë¹Œë“œ ì™„ë£Œ: $IMAGE_NAME:$IMAGE_TAG

.backend-default-push:
  rules:
    - if: '$CI_COMMIT_BRANCH == "master" && $CI_PIPELINE_SOURCE == "push"'
      when: always
    - if: '$CI_COMMIT_BRANCH == "master" && $CI_PIPELINE_SOURCE == "web"'     # ìˆ˜ë™ ì‹¤í–‰ë„ í—ˆìš©í•˜ë ¤ë©´
      when: manual
    - when: never
  tags:
    - $GITLAB_USER_EMAIL
  stage: push
  script:
    - docker images
    - docker login -u "$DOCKERHUB_USERNAME" -p "$DOCKERHUB_TOKEN"
    - docker push ${DOCKERHUB_USERNAME:-default}/$REGISTRY_PATH-${SERVICE_NAME}:$IMAGE_TAG

.backend-default-deploy:
  rules:
    - if: '$CI_COMMIT_BRANCH == "master" && $CI_PIPELINE_SOURCE == "push"'
      when: always
    - if: '$CI_COMMIT_BRANCH == "master" && $CI_PIPELINE_SOURCE == "web"'     # ìˆ˜ë™ ì‹¤í–‰ë„ í—ˆìš©í•˜ë ¤ë©´
      when: manual
    - when: never
  tags:
    - $GITLAB_USER_EMAIL
  stage: deploy
  before_script:
    - apk add --no-cache openssh gettext
  script:
    # ğŸ” bastion key ë³µì›
    - echo "$BASTION_PRIVATE_KEY_B64" | base64 -d > bastion.pem
    - chmod 600 bastion.pem

    # ğŸ“„ íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
    - '[ -f "$NAMESPACE_PATH" ] || { echo "âŒ NAMESPACE_PATH íŒŒì¼ ì—†ìŒ: $NAMESPACE_PATH"; exit 1; }'
    - '[ -f "$K8S_PATH" ] || { echo "âŒ K8S_PATH íŒŒì¼ ì—†ìŒ: $K8S_PATH"; exit 1; }'
    - '[ -f .env ] || { echo "âŒ .env íŒŒì¼ ì—†ìŒ"; exit 1; }'

    # ğŸ“¦ ê³µìš© í™˜ê²½ë³€ìˆ˜ ConfigMap ìƒì„±
    - echo "ğŸ“¦ ê³µìš© .env ê¸°ë°˜ ConfigMap ìƒì„± ì¤‘..."
    - kubectl create configmap common-env --from-env-file=.env --dry-run=client -o yaml > configmap.yml

    # ğŸ“¦ YAML í…œí”Œë¦¿ ë³€ìˆ˜ ì¹˜í™˜
    - echo "ğŸ“¦ ë°°í¬ íŒŒì¼ ë³€ìˆ˜ ì¹˜í™˜ ì¤‘..."
    - export IMAGE_TAG="${CI_COMMIT_SHORT_SHA}"
    - export DOCKERHUB_USERNAME="${DOCKERHUB_USERNAME}"
    - export REGISTRY_PATH="${REGISTRY_PATH}"
    - export SERVICE_NAME="${SERVICE_NAME}"
    - envsubst '${DOCKERHUB_USERNAME} ${REGISTRY_PATH} ${SERVICE_NAME} ${IMAGE_TAG}' < "$K8S_PATH" > deploy.rendered.yml
    - echo "ğŸ” ì¹˜í™˜ëœ ë°°í¬ íŒŒì¼ ë‚´ìš©:"
    - cat deploy.rendered.yml

    # ğŸ”§ remote ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
    - |
      cat << 'EOF' > deploy.sh
      #!/bin/bash
      set -e

      echo "ğŸ“¦ ConfigMap ì ìš© ì¤‘..."
      kubectl apply -f /tmp/configmap.yml || { echo "âŒ configmap apply ì‹¤íŒ¨"; exit 1; }

      echo "ğŸ“¦ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì ìš© ì¤‘..."
      kubectl apply -f /tmp/namespace.yml || { echo "âŒ namespace apply ì‹¤íŒ¨"; exit 1; }

      echo "ğŸ“¦ ë°°í¬ ì ìš© ì¤‘..."
      kubectl apply -f /tmp/deploy.yml || { echo "âŒ deploy apply ì‹¤íŒ¨"; exit 1; }

      echo "âœ… ë°°í¬ ì™„ë£Œ"
      EOF

    - chmod +x deploy.sh

    # ğŸ“¤ Bastionìœ¼ë¡œ íŒŒì¼ ì „ì†¡
    - scp -i bastion.pem -o StrictHostKeyChecking=no "$NAMESPACE_PATH" ubuntu@"$BASTION_HOST":/tmp/namespace.yml
    - scp -i bastion.pem -o StrictHostKeyChecking=no deploy.rendered.yml ubuntu@"$BASTION_HOST":/tmp/deploy.yml
    - scp -i bastion.pem -o StrictHostKeyChecking=no configmap.yml ubuntu@"$BASTION_HOST":/tmp/configmap.yml
    - scp -i bastion.pem -o StrictHostKeyChecking=no deploy.sh ubuntu@"$BASTION_HOST":/tmp/deploy.sh

    # ğŸš€ Bastionì—ì„œ ì‹¤í–‰
    - ssh -i bastion.pem -o StrictHostKeyChecking=no ubuntu@"$BASTION_HOST" "bash /tmp/deploy.sh"