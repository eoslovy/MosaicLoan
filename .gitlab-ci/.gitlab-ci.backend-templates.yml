####
#test_template_trigger:
#tags:
# - $GITLAB_USER_EMAIL
#script:
# - echo "CI ì •ìƒ ì‘ë™ ì—¬ë¶€ í™•ì¸"
# - echo "ğŸ” ë³€ê²½ëœ íŒŒì¼ ëª©ë¡:"
# - git diff --name-only $CI_COMMIT_BEFORE_SHA $CI_COMMIT_SHA

.backend-default-build:
  stage: build
  tags:
    - $GITLAB_USER_EMAIL
  script:
    - echo "ğŸ”¨ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ ì¤‘..."
    - docker build -t ${DOCKERHUB_USERNAME:-default}/$REGISTRY_PATH-${SERVICE_NAME}:$IMAGE_TAG ${BUILD_CONTEXT}
    #- echo "âœ… ë¹Œë“œ ì™„ë£Œ: $IMAGE_NAME:$IMAGE_TAG

.backend-default-push:
  rules:
    - if: '$CI_COMMIT_BRANCH == "master" && $CI_PIPELINE_SOURCE == "push"'
      when: always
    - if: '$CI_COMMIT_BRANCH == "master" && $CI_PIPELINE_SOURCE == "web"' # ìˆ˜ë™ ì‹¤í–‰ë„ í—ˆìš©í•˜ë ¤ë©´
      when: manual
    - when: never
  tags:
    - $GITLAB_USER_EMAIL
  stage: push
  script:
    - docker images
    - docker login -u "$DOCKERHUB_USERNAME" -p "$DOCKERHUB_TOKEN"
    - docker push ${DOCKERHUB_USERNAME:-default}/$REGISTRY_PATH-${SERVICE_NAME}:$IMAGE_TAG

.backend-default-deploy:
  rules:
    - if: '$CI_COMMIT_BRANCH == "master" && $CI_PIPELINE_SOURCE == "push"'
      when: always
    - if: '$CI_COMMIT_BRANCH == "master" && $CI_PIPELINE_SOURCE == "web"' # ìˆ˜ë™ ì‹¤í–‰ë„ í—ˆìš©í•˜ë ¤ë©´
      when: manual
    - when: never
  tags:
    - $GITLAB_USER_EMAIL
  stage: deploy
  before_script:
    - apk add --no-cache openssh gettext coreutils
  script:
    # 1ï¸âƒ£ SSH Key ì„¤ì •
    #- apt-get update && apt-get install -y openssh-client basez
    - mkdir -p ~/.ssh
    - echo "$BASTION_PRIVATE_KEY_B64" | base64 -d > bastion.pem
    - chmod 600 bastion.pem
    - echo "$ENV_FILE_CONTENT" > .env
      # 2ï¸âƒ£ ë°°í¬ ì„œë²„ì— Docker ë¡œê·¸ì¸ ì •ë³´ ì „ì†¡
      #- ssh -T -o StrictHostKeyChecking=no -i bastion.pem ubuntu@$BASTION_HOST "echo \"$DOCKER_HUB_TOKEN\" | docker login --username \"$DOCKER_HUB_USERNAME\" --password-stdin"
    - cat docker-compose.deploy.yml
      # 3ï¸âƒ£ í™˜ê²½ë³€ìˆ˜ê°€ ë°˜ì˜ëœ `docker-compose.yml`ì„ ë°°í¬ ì„œë²„ë¡œ ì „ì†¡
    - envsubst < docker-compose.deploy.yml > docker-compose.processed.yml
    - cat docker-compose.processed.yml
    - scp -o StrictHostKeyChecking=no -i bastion.pem .env ubuntu@$BASTION_HOST:/home/ubuntu/.env

    - scp -o StrictHostKeyChecking=no -i bastion.pem docker-compose.processed.yml ubuntu@$BASTION_HOST:/home/ubuntu/docker-compose.yml

    - ssh -T -o StrictHostKeyChecking=no -i bastion.pem ubuntu@$BASTION_HOST "
      cd /home/ubuntu && \
      docker-compose stop $SERVICE_NAME && \
      docker-compose rm -f $SERVICE_NAME && \
      IMAGE_TAG=$IMAGE_TAG docker-compose pull $SERVICE_NAME && \
      IMAGE_TAG=$IMAGE_TAG docker-compose up -d --no-build --force-recreate $SERVICE_NAME
      "

    # 4ï¸âƒ£ ë°°í¬ ì„œë²„ì—ì„œ `docker-compose` ì‹¤í–‰ (ë¡œê·¸ì¸ ìœ ì§€ë¨)
    #- ssh -T -o StrictHostKeyChecking=no -i bastion.pem ubuntu@$BASTION_HOST \
    #  "bash -l -c '
    #     DOCKERHUB_USERNAME=$DOCKERHUB_USERNAME \
    #    IMAGE_TAG=$IMAGE_TAG \
    #    SERVICE_NAME=$SERVICE_NAME \
    #    docker-compose -f /home/ubuntu/docker-compose.yml pull \$SERVICE_NAME && \
    #    docker-compose -f /home/ubuntu/docker-compose.yml up -d \$SERVICE_NAME --remove-orphans
    #  '"
    - ssh -T -o StrictHostKeyChecking=no -i bastion.pem ubuntu@$BASTION_HOST "
      docker ps"

.modeling-default-deploy:
  rules:
    - if: '$CI_COMMIT_BRANCH == "master" && $CI_PIPELINE_SOURCE == "push"'
      when: always
    - if: '$CI_COMMIT_BRANCH == "master" && $CI_PIPELINE_SOURCE == "web"' # ìˆ˜ë™ ì‹¤í–‰ë„ í—ˆìš©í•˜ë ¤ë©´
      when: manual
    - when: never
  tags:
    - $GITLAB_USER_EMAIL
  stage: deploy
  before_script:
    - apk add --no-cache openssh gettext coreutils
  script:
    # 1ï¸âƒ£ SSH Key ì„¤ì •
    #- apt-get update && apt-get install -y openssh-client basez
    - mkdir -p ~/.ssh
    - echo "$BASTION_PRIVATE_KEY_B64" | base64 -d > bastion.pem
    - chmod 600 bastion.pem
    - echo "$ENV_FILE_CONTENT" > .env
      # 2ï¸âƒ£ ë°°í¬ ì„œë²„ì— Docker ë¡œê·¸ì¸ ì •ë³´ ì „ì†¡
      #- ssh -T -o StrictHostKeyChecking=no -i bastion.pem ubuntu@$BASTION_HOST "echo \"$DOCKER_HUB_TOKEN\" | docker login --username \"$DOCKER_HUB_USERNAME\" --password-stdin"
    - cat docker-compose.model-deploy.yml
      # 3ï¸âƒ£ í™˜ê²½ë³€ìˆ˜ê°€ ë°˜ì˜ëœ `docker-compose.yml`ì„ ë°°í¬ ì„œë²„ë¡œ ì „ì†¡
    - envsubst < docker-compose.model-deploy.yml > docker-compose.processed.yml
    - cat docker-compose.processed.yml
    - scp -o StrictHostKeyChecking=no -i bastion.pem .env ubuntu@$MODEL_HOST:/home/ubuntu/.env

    - scp -o StrictHostKeyChecking=no -i bastion.pem docker-compose.processed.yml ubuntu@$MODEL_HOST:/home/ubuntu/docker-compose.yml

    - ssh -T -o StrictHostKeyChecking=no -i bastion.pem ubuntu@$MODEL_HOST "
      cd /home/ubuntu && \
      docker-compose stop $SERVICE_NAME && \
      docker-compose rm -f $SERVICE_NAME && \
      IMAGE_TAG=$IMAGE_TAG docker-compose pull $SERVICE_NAME && \
      IMAGE_TAG=$IMAGE_TAG docker-compose up -d --no-build --force-recreate $SERVICE_NAME
      "
    # 4ï¸âƒ£ ë°°í¬ ì„œë²„ì—ì„œ `docker-compose` ì‹¤í–‰ (ë¡œê·¸ì¸ ìœ ì§€ë¨)
    #- ssh -T -o StrictHostKeyChecking=no -i bastion.pem ubuntu@$MODEL_HOST \
    #  "bash -l -c '
    #     DOCKERHUB_USERNAME=$DOCKERHUB_USERNAME \
    #    IMAGE_TAG=$IMAGE_TAG \
    #    SERVICE_NAME=$SERVICE_NAME \
    #    docker-compose -f /home/ubuntu/docker-compose.yml pull \$SERVICE_NAME && \
    #    docker-compose -f /home/ubuntu/docker-compose.yml up -d \$SERVICE_NAME --remove-orphans
    #  '"
    - ssh -T -o StrictHostKeyChecking=no -i bastion.pem ubuntu@$MODEL_HOST "
      docker ps"
